# 📦 Структура проекта

```
tg-servmonitoringbot/
│
├── 📄 bot.py                      # Главный файл запуска бота
├── 📄 config.py                   # Конфигурация и настройки
├── 📄 requirements.txt            # Python зависимости
│
├── 📁 handlers/                   # Обработчики команд Telegram
│   ├── __init__.py
│   ├── basic.py                   # /start, /help, /about
│   ├── monitoring.py              # /status, /cpu, /memory, /disk, /processes, /network
│   └── services.py                # /services, /logs
│
├── 📁 services/                   # Бизнес-логика мониторинга
│   ├── __init__.py
│   ├── system_monitor.py          # Мониторинг системных ресурсов (psutil)
│   ├── service_monitor.py         # Мониторинг systemd сервисов
│   └── notifier.py                # Отправка уведомлений пользователям
│
├── 📁 middleware/                 # Middleware для обработки запросов
│   ├── __init__.py
│   └── auth.py                    # Whitelist авторизация
│
├── 📁 utils/                      # Утилиты и вспомогательные функции
│   ├── __init__.py
│   └── formatters.py              # Форматирование байтов, процентов, прогресс-баров
│
├── 📁 Документация/
│   ├── README.md                  # Полная документация проекта
│   ├── QUICKSTART.md              # Быстрый старт (5 минут)
│   ├── CHEATSHEET.md              # Шпаргалка по командам
│   ├── EXAMPLES.md                # Примеры использования
│   ├── OUTPUT_EXAMPLES.md         # Примеры вывода команд
│   ├── ROADMAP.md                 # Планы развития
│   └── PROJECT_STRUCTURE.md       # Этот файл
│
├── 📁 Настройка/
│   ├── .env.example               # Пример конфигурации
│   ├── .gitignore                 # Игнорируемые файлы
│   ├── tg-monitor-bot.service     # Systemd сервис
│   └── install.sh                 # Скрипт автоматической установки
│
└── 📁 venv/                       # Виртуальное окружение (создаётся при установке)
```

---

## 📊 Архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                     Telegram Bot API                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│                      bot.py (main)                          │
│  ┌────────────────────────────────────────────────────┐    │
│  │ • Инициализация бота и диспетчера                  │    │
│  │ • Подключение middleware и роутеров                │    │
│  │ • Запуск фоновых задач мониторинга                 │    │
│  │ • Обработка уведомлений                            │    │
│  └────────────────────────────────────────────────────┘    │
└──────────┬────────────────────┬──────────────────┬──────────┘
           │                    │                  │
           ▼                    ▼                  ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│   Middleware     │ │    Handlers      │ │    Services      │
│                  │ │                  │ │                  │
│ • AuthMiddleware │ │ • basic.py       │ │ • SystemMonitor  │
│   (whitelist)    │ │ • monitoring.py  │ │ • ServiceMonitor │
│                  │ │ • services.py    │ │ • Notifier       │
└──────────────────┘ └──────────────────┘ └────────┬─────────┘
                                                    │
                                                    ▼
                                         ┌──────────────────────┐
                                         │   Системные ресурсы  │
                                         │                      │
                                         │ • psutil → CPU/RAM   │
                                         │ • systemctl → сервисы│
                                         │ • journalctl → логи  │
                                         └──────────────────────┘
```

---

## 🔄 Поток данных

### 1. Обработка команды пользователя

```
Пользователь → /status
    ↓
Telegram API
    ↓
bot.py (Dispatcher)
    ↓
AuthMiddleware (проверка whitelist)
    ↓
monitoring.py (обработчик команды)
    ↓
SystemMonitor.format_status_message()
    ↓
psutil (сбор метрик)
    ↓
formatters.py (форматирование)
    ↓
Отправка сообщения пользователю
```

### 2. Фоновый мониторинг сервисов

```
asyncio.create_task(service_monitor.monitor_services())
    ↓
Каждые 60 секунд:
    ↓
ServiceMonitor.check_all_services()
    ↓
systemctl is-active <service>
    ↓
Сравнение с предыдущим статусом
    ↓
Если изменился статус:
    ↓
Добавление в очередь уведомлений
    ↓
Notifier.send_notification()
    ↓
Отправка всем пользователям из whitelist
```

### 3. Мониторинг дисков

```
asyncio.create_task(check_disk_space())
    ↓
Каждые 5 минут:
    ↓
SystemMonitor.get_disk_info()
    ↓
psutil.disk_usage()
    ↓
Проверка порога (85%)
    ↓
Если превышен:
    ↓
Notifier.send_notification()
    ↓
Отправка предупреждения
```

---

## 🔑 Ключевые компоненты

### bot.py
**Назначение:** Точка входа приложения
- Создаёт экземпляры Bot и Dispatcher
- Регистрирует middleware и handlers
- Запускает фоновые задачи мониторинга
- Управляет жизненным циклом бота

### config.py
**Назначение:** Централизованная конфигурация
- Загрузка переменных из .env
- Валидация обязательных параметров
- Конфигурация интервалов и порогов
- Версионирование

### handlers/
**Назначение:** Обработка команд пользователя
- `basic.py` - базовые команды (/start, /help)
- `monitoring.py` - системный мониторинг
- `services.py` - мониторинг сервисов

### services/
**Назначение:** Бизнес-логика
- `system_monitor.py` - работа с psutil
- `service_monitor.py` - работа с systemd
- `notifier.py` - отправка уведомлений

### middleware/
**Назначение:** Промежуточная обработка
- `auth.py` - проверка whitelist

### utils/
**Назначение:** Вспомогательные функции
- `formatters.py` - красивое форматирование данных

---

## 🧩 Зависимости

```python
aiogram==3.15.0      # Telegram Bot API
psutil==6.1.0        # Системные метрики
python-dotenv==1.0.1 # Загрузка .env
aiohttp==3.10.10     # HTTP клиент (для aiogram)
```

---

## 🚀 Жизненный цикл бота

```
1. Запуск bot.py
    ↓
2. Загрузка config.py (чтение .env)
    ↓
3. Создание Bot и Dispatcher
    ↓
4. Регистрация middleware (авторизация)
    ↓
5. Регистрация handlers (команды)
    ↓
6. Создание сервисов:
   - SystemMonitor
   - ServiceMonitor
   - Notifier
    ↓
7. Запуск фоновых задач:
   - Мониторинг сервисов (60 сек)
   - Мониторинг дисков (5 мин)
   - Мониторинг uptime (30 сек)
   - Обработка очереди уведомлений
    ↓
8. Отправка уведомления о старте
    ↓
9. Начало polling (обработка команд)
    ↓
10. Работа 24/7 до остановки
```

---

## 🔐 Безопасность

### Уровни защиты:

1. **Whitelist пользователей**
   - Middleware проверяет каждое сообщение
   - Только разрешённые ID могут использовать бота

2. **Переменные окружения**
   - Токен и чувствительные данные в .env
   - .env в .gitignore

3. **Systemd изоляция**
   - Бот запускается от непривилегированного пользователя
   - Нет доступа к sudo (пока)

4. **Логирование**
   - Все действия логируются
   - Неавторизованные попытки видны в логах

---

## 📈 Масштабируемость

### Текущие ограничения:
- 1 сервер
- ~10 сервисов (рекомендуется)
- Без истории метрик
- Без БД

### Возможности расширения:
- Добавить SQLite для истории
- Мультисерверный мониторинг
- Кластер ботов для отказоустойчивости
- Интеграция с внешними системами

---

## 🛠 Разработка

### Добавление новой команды:

1. **Создайте обработчик** в `handlers/`
```python
@router.message(Command("newcmd"))
async def cmd_newcmd(message: Message):
    await message.answer("Ответ")
```

2. **Зарегистрируйте роутер** в `bot.py`
```python
dp.include_router(your_router)
```

3. **Добавьте в /help** в `handlers/basic.py`

### Добавление новой метрики:

1. **Добавьте метод** в `services/system_monitor.py`
```python
def get_new_metric(self):
    # Ваш код
    return data
```

2. **Создайте форматтер**
```python
def format_new_metric_message(self):
    data = self.get_new_metric()
    return f"Метрика: {data}"
```

3. **Используйте в handlers**

---

## 🧪 Тестирование

### Ручное тестирование:
```bash
# Запустите в тестовом режиме
python bot.py

# В другом терминале смотрите логи
journalctl -u tg-monitor-bot -f
```

### Unit тесты (будущее):
- pytest для тестирования функций
- Mock для psutil и systemctl
- Интеграционные тесты для Telegram API

---

## 📝 Логирование

### Уровни логов:
- `INFO` - нормальная работа
- `WARNING` - предупреждения (диск заполнен, сервис упал)
- `ERROR` - ошибки (не удалось подключиться и т.д.)

### Где смотреть логи:
```bash
# Логи бота
sudo journalctl -u tg-monitor-bot -f

# Последние 100 строк
sudo journalctl -u tg-monitor-bot -n 100

# Логи за сегодня
sudo journalctl -u tg-monitor-bot --since today
```

---

## 🎯 Best Practices

1. **Используйте venv** - изоляция зависимостей
2. **Запускайте через systemd** - автозапуск и автоперезапуск
3. **Следите за логами** - раннее обнаружение проблем
4. **Регулярно обновляйте** - новые версии зависимостей
5. **Не храните токены в коде** - только .env
6. **Ограничьте whitelist** - только доверенные пользователи
7. **Мониторьте ~5 критичных сервисов** - не перегружайте

---

## 📚 Дополнительные ресурсы

- [aiogram документация](https://docs.aiogram.dev/)
- [psutil документация](https://psutil.readthedocs.io/)
- [systemd документация](https://www.freedesktop.org/software/systemd/man/)
- [Telegram Bot API](https://core.telegram.org/bots/api)

---

**Проект готов к использованию и легко расширяется! 🚀**

